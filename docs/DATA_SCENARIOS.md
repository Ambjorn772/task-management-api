# Сценарії оновлення, зміни та агрегації даних

## Ключові сценарії системи

### 1. Створення користувача та завдання

**Сценарій:** Користувач реєструється в системі і створює своє перше завдання

**Потік даних:**

```
1. POST /users
   ├─ Валідація даних (username, email)
   ├─ Перевірка унікальності username та email
   ├─ Створення нового запису Users
   │  ├─ id: auto-increment
   │  ├─ username: з запиту
   │  ├─ email: з запиту
   │  ├─ firstName: з запиту
   │  ├─ lastName: з запиту
   │  ├─ createdAt: поточна дата/час
   │  └─ updatedAt: поточна дата/час
   └─ Повернення створеного користувача

2. POST /tasks
   ├─ Валідація даних (title, userId)
   ├─ Перевірка існування користувача (userId)
   ├─ Створення нового запису Tasks
   │  ├─ id: auto-increment
   │  ├─ userId: з запиту (FK до Users)
   │  ├─ title: з запиту
   │  ├─ description: з запиту
   │  ├─ status: 'pending' (за замовчуванням)
   │  ├─ priority: з запиту або 'medium' (за замовчуванням)
   │  ├─ dueDate: з запиту
   │  ├─ createdAt: поточна дата/час
   │  └─ updatedAt: поточна дата/час
   └─ Повернення створеного завдання
```

**Оновлення даних:**

- Додається новий запис в таблицю Users
- Додається новий запис в таблицю Tasks з посиланням на Users

---

### 2. Оновлення статусу завдання

**Сценарій:** Користувач змінює статус завдання з "pending" на "in-progress"

**Потік даних:**

```
PUT /tasks/:id
├─ Валідація taskId
├─ Перевірка існування завдання
├─ Валідація нового статусу (enum: pending, in-progress, completed, cancelled)
├─ Оновлення запису Tasks
│  ├─ status: нове значення з запиту
│  └─ updatedAt: поточна дата/час (автоматично)
└─ Повернення оновленого завдання
```

**Оновлення даних:**

- Оновлюється поле `status` в таблиці Tasks
- Автоматично оновлюється `updatedAt`

---

### 3. Отримання завдань користувача з агрегацією

**Сценарій:** Користувач переглядає всі свої завдання з статистикою

**Потік даних:**

```
GET /users/:id/tasks
├─ Валідація userId
├─ Перевірка існування користувача
├─ Запит до Tasks Service: GET /tasks/user/:userId
│  ├─ Фільтрація Tasks за userId
│  ├─ Сортування (за createdAt або dueDate)
│  └─ Повернення масиву завдань
├─ Агрегація даних:
│  ├─ Загальна кількість завдань
│  ├─ Кількість за статусами:
│  │  ├─ pending: COUNT WHERE status = 'pending'
│  │  ├─ in-progress: COUNT WHERE status = 'in-progress'
│  │  ├─ completed: COUNT WHERE status = 'completed'
│  │  └─ cancelled: COUNT WHERE status = 'cancelled'
│  ├─ Кількість за пріоритетами:
│  │  ├─ high: COUNT WHERE priority = 'high'
│  │  ├─ medium: COUNT WHERE priority = 'medium'
│  │  └─ low: COUNT WHERE priority = 'low'
│  └─ Прострочені завдання: COUNT WHERE dueDate < NOW() AND status != 'completed'
└─ Повернення завдань + статистики
```

**Агрегація даних:**

- Групування за статусами (GROUP BY status)
- Групування за пріоритетами (GROUP BY priority)
- Фільтрація за датами (WHERE dueDate < NOW())

---

### 4. Видалення користувача з каскадним видаленням завдань

**Сценарій:** Адміністратор видаляє користувача, всі його завдання також видаляються

**Потік даних:**

```
DELETE /users/:id
├─ Валідація userId
├─ Перевірка існування користувача
├─ Каскадне видалення (CASCADE DELETE):
│  ├─ Видалення всіх Tasks WHERE userId = :id
│  │  ├─ DELETE FROM Tasks WHERE userId = :id
│  │  └─ Кількість видалених завдань: N
│  └─ Видалення Users WHERE id = :id
│     └─ DELETE FROM Users WHERE id = :id
└─ Повернення підтвердження видалення
```

**Оновлення даних:**

- Видаляються всі записи з таблиці Tasks, де userId = :id
- Видаляється запис з таблиці Users

---

### 5. Оновлення пріоритету та терміну виконання завдання

**Сценарій:** Користувач змінює пріоритет та термін виконання завдання

**Потік даних:**

```
PUT /tasks/:id
├─ Валідація taskId
├─ Перевірка існування завдання
├─ Валідація даних (priority, dueDate)
├─ Оновлення запису Tasks
│  ├─ priority: нове значення (якщо передано)
│  ├─ dueDate: нове значення (якщо передано)
│  └─ updatedAt: поточна дата/час (автоматично)
└─ Повернення оновленого завдання
```

**Оновлення даних:**

- Оновлюються поля `priority` та `dueDate` в таблиці Tasks
- Автоматично оновлюється `updatedAt`

---

### 6. Агрегація статистики по всіх користувачах

**Сценарій:** Адміністратор переглядає загальну статистику системи

**Потік даних:**

```
GET /users/stats (або окремий endpoint)
├─ Агрегація даних з Users:
│  ├─ Загальна кількість користувачів: COUNT(*)
│  └─ Кількість активних користувачів: COUNT WHERE createdAt > DATE_SUB(NOW(), INTERVAL 30 DAY)
├─ Агрегація даних з Tasks (через Tasks Service):
│  ├─ Загальна кількість завдань: COUNT(*)
│  ├─ Завдання за статусами: GROUP BY status
│  ├─ Завдання за пріоритетами: GROUP BY priority
│  └─ Середня кількість завдань на користувача: COUNT(Tasks) / COUNT(Users)
└─ Повернення агрегованої статистики
```

**Агрегація даних:**

- JOIN між Users та Tasks
- GROUP BY для групування
- COUNT, AVG для підрахунку
- Фільтрація за датами

---

## Діаграма потоку даних для основного сценарію

```
┌──────────┐
│  Client  │
└────┬─────┘
     │
     │ POST /users
     ▼
┌─────────────────┐
│ Users Service   │
│  Controller     │
└────┬────────────┘
     │
     │ Validate & Create
     ▼
┌─────────────────┐
│ Users Repository│
│  (Create User)  │
└────┬────────────┘
     │
     │ INSERT INTO Users
     ▼
┌─────────────────┐
│   Users Model   │
│  (New Record)   │
└─────────────────┘
     │
     │ Response: User
     ▼
┌──────────┐
│  Client  │
└────┬─────┘
     │
     │ POST /tasks (userId)
     ▼
┌─────────────────┐
│ Tasks Service   │
│  Controller     │
└────┬────────────┘
     │
     │ Validate userId exists
     │ (можлива перевірка через Users Service)
     ▼
┌─────────────────┐
│ Tasks Repository│
│  (Create Task)  │
└────┬────────────┘
     │
     │ INSERT INTO Tasks (userId FK)
     ▼
┌─────────────────┐
│   Tasks Model   │
│  (New Record)   │
└─────────────────┘
```

## Опис операцій CRUD

### Create (Створення)

- **Users**: Створення нового користувача з унікальними username та email
- **Tasks**: Створення нового завдання з посиланням на існуючого користувача

### Read (Читання)

- **Users**: Отримання користувача за ID, списку всіх користувачів
- **Tasks**: Отримання завдання за ID, списку завдань користувача, всіх завдань

### Update (Оновлення)

- **Users**: Оновлення даних користувача (firstName, lastName, email)
- **Tasks**: Оновлення статусу, пріоритету, терміну виконання, опису

### Delete (Видалення)

- **Users**: Видалення користувача з каскадним видаленням завдань
- **Tasks**: Видалення окремого завдання
